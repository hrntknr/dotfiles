#!/bin/bash -e

if ! type jq >/dev/null 2>&1; then
  echo "jq is required." >&2
  exit 1
fi

if [ -z "$NTFY" ] && [ -z "$SLACK_WEBHOOK_URL" ]; then
  echo "NTFY is required." >&2
  exit 1
fi

if [ "$(uname)" = "Darwin" ]; then
  PS="$(ps -ax -o pid= -o ppid= -o tty= -o etime= -o command=)"
else
  PS="$(ps -u "$USER" -o pid=,ppid=,tty=,etime=,args= --no-headers)"
fi
list=$(
  echo "$PS" | \
  awk '$3 !~ /^\?/' | \
  awk '$5 != "login"' | \
  awk '
    {
      ppid[$1] = $2;
      args[$1] = $0;
    }
    END {
      for (p in ppid)
        if (ppid[p] in ppid == 1)
          if (ppid[ppid[p]] in ppid == 0)
            print args[p];
    }
  ' | \
  awk "\$1 !~ $$" | \
  sort -k4
)

target=$(echo "$list" | peco)
if [ -z "$target" ]; then
  exit 1
fi

export pid=$(echo "$target" | awk '{print $1}')
export cmd=$(echo "$target" | awk '{print $5}')

nohup bash > /dev/null 2>&1 <<'EOF' &
while kill -0 "$pid" 2>/dev/null; do
  sleep .5
done
msg="âœ… : $cmd"
if [ -n "$NTFY" ]; then
  curl -sf -d "$msg" "$NTFY" -o /dev/null
elif [ -n "$SLACK_WEBHOOK_URL" ]; then
  payload=$(jq -n --arg text "$msg" '{text: $text}')
  curl -sf -H "Content-Type: application/json" -d "$payload" "$SLACK_WEBHOOK_URL" -o /dev/null
fi
EOF
